# 视觉编码器冻结分析

## 当前情况

- **模型**：DINOv2 (vit_small_patch14_dinov2.lvd142m)
- **状态**：已冻结（`requires_grad=False`）
- **输出**：384 维特征
- **用途**：与 LiDAR 特征融合进行位置识别

## 冻结 vs 不冻结

### 冻结的理由 ✅

1. **预训练模型质量高**
   - DINOv2 在大规模数据上预训练，特征表示能力强
   - 通用视觉特征已经很好，可能不需要微调

2. **训练稳定性**
   - 避免破坏预训练特征
   - 减少训练不稳定性
   - 减少过拟合风险

3. **计算效率**
   - 减少可训练参数量
   - 减少梯度计算和内存占用
   - 训练更快

4. **任务适配**
   - `proj_layer` 可以学习如何融合预训练特征
   - 融合层已经足够灵活

### 不冻结的理由 ⚠️

1. **任务特定性**
   - DINOv2 是通用视觉模型
   - 位置识别任务可能需要任务特定的特征
   - 微调可能提升性能

2. **数据域差异**
   - nuScenes 的视觉数据可能与预训练数据有差异
   - 微调可以适应特定数据分布

3. **融合效果**
   - 如果视觉和 LiDAR 特征不匹配，微调可能改善融合效果

## 建议策略

### 方案 1：保持冻结（推荐开始）✅
- **优点**：训练稳定，快速收敛
- **适用**：如果当前效果已经不错（Recall@1: 83%），可以保持冻结
- **学习率**：融合层用很小学习率（lr * 0.1）

### 方案 2：微调但用很小学习率 ⚠️
- **优点**：可能提升性能
- **缺点**：需要小心调整，可能不稳定
- **学习率**：视觉编码器用极小学习率（lr * 0.01 或 0.001）
- **适用**：如果冻结效果不够好，可以尝试

### 方案 3：渐进式解冻 🔄
- **阶段1**：前 N 个 epoch 冻结，让融合层先学习
- **阶段2**：解冻视觉编码器，用很小学习率微调
- **适用**：如果训练后期需要进一步提升

## 当前训练情况

- **Recall@1**: 83.60%（第一轮）
- **Loss**: 0.04 左右（已经很低）
- **问题**: Loss 波动，Recall 不提升

## 建议

**先保持冻结**，因为：
1. 当前效果已经不错（83%）
2. Loss 波动可能是其他原因（学习率、数据等）
3. 可以先通过调整学习率分组解决波动问题

**如果效果不够好**，再考虑：
1. 解冻视觉编码器
2. 用极小学习率（lr * 0.01）微调
3. 观察是否提升
